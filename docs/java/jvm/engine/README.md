---
title: 执行引擎
date: 2020-12-11 11:15:53
permalink: /java/jvm/engine
categories:
  - 后端
tags:
  - JVM
author: zhuib
---

## 执行引擎
## JVM 执行引擎详解

## 1. 概述

执行引擎是 Java 虚拟机（JVM）的核心组成部分之一，负责**执行**由编译器生成的字节码，并将字节码转换为机器指令，最终在底层硬件上运行。执行引擎在 JVM 的运行时数据区的基础上工作，负责解释或编译字节码，并将其转化为操作系统可以执行的指令。

## 2. 执行引擎的工作流程

执行引擎接收字节码指令作为输入，然后逐步执行这些指令。 主要工作流程如下：

1.  **加载字节码**：从方法区加载需要执行的字节码。
2.  **解释执行或编译执行**：
    *   **解释器（Interpreter）**：逐条读取字节码指令，解释并执行。速度较慢，但不需要额外的编译时间。
    *   **即时编译器（Just-In-Time Compiler, JIT）**：将热点代码（经常执行的代码）编译成机器码，以提高执行效率。
3.  **执行机器指令**：将转换后的机器指令提交给操作系统执行。

## 3. 解释器（Interpreter）

### 3.1 作用

解释器是执行引擎中最基本的部分。当 JVM 启动时，解释器会首先被使用，逐条解释并执行字节码指令。

### 3.2 工作方式

1.  **字节码读取**：解释器从方法区读取字节码指令。
2.  **指令翻译**：将字节码指令翻译成对应的机器指令。
3.  **指令执行**：执行翻译后的机器指令。
4.  **循环执行**：重复以上步骤，直到方法执行结束。

### 3.3 优点

*   **启动速度快**：无需额外的编译时间，可以立即执行。
*   **节省内存**：不需要存储编译后的机器码。

### 3.4 缺点

*   **执行速度慢**：逐条解释执行，效率较低。 对于相同的指令，每次都需要重新解释。

## 4. 即时编译器（JIT Compiler）

### 4.1 作用

即时编译器（JIT）是 JVM 的性能优化关键组件，能够在运行时将热点代码编译成机器码，从而显著提高程序的执行效率。

### 4.2 热点代码（Hot Spot Code）

热点代码是指被频繁执行的代码片段。 JIT 编译器会重点关注并优化这些代码，以达到最佳性能。 热点代码主要包括：

1.  **被多次调用的方法**
2.  **被多次执行的循环体**

### 4.3 JIT 编译的过程

1.  **代码识别**：JVM 通过**计数器**来识别热点代码。
    *   **方法调用计数器**：统计方法被调用的次数。
    *   **回边计数器**：统计循环体被执行的次数。
2.  **编译触发**：当计数器的值超过一定的阈值时，触发 JIT 编译。
3.  **编译优化**：JIT 编译器对热点代码进行多种优化，例如：
    *   **内联（Inlining）**：将短小的方法调用直接嵌入到调用处，减少方法调用的开销。
    *   **逃逸分析（Escape Analysis）**：分析对象的应用范围，确定对象是否只在当前线程或方法内使用，从而进行锁消除或栈上分配等优化。
    *   **公共子表达式消除（Common Subexpression Elimination）**：消除重复的计算，减少指令执行次数。
4.  **机器码生成**：将优化后的代码编译成机器码。
5.  **代码替换**：用编译后的机器码替换原有的字节码，后续执行直接使用机器码。

### 4.4 JIT 编译器的类型

HotSpot JVM 中包含两种 JIT 编译器：

1.  **C1 编译器（Client Compiler）**：
    *   **目标**：为快速启动和较短的执行时间优化。
    *   **优化策略**：采用相对简单的优化策略，适用于客户端应用程序。
2.  **C2 编译器（Server Compiler）**：
    *   **目标**：为长时间运行和高性能优化。
    *   **优化策略**：采用更复杂的优化策略，例如全局代码优化，适用于服务器端应用程序。

### 4.5 分层编译（Tiered Compilation）

为了兼顾启动速度和运行性能，HotSpot JVM 引入了分层编译策略：

1.  **第一层（Layer 0）：解释执行**：使用解释器逐条解释执行字节码。
2.  **第二层（Layer 1）：C1 编译**：使用 C1 编译器对热点代码进行简单优化。
3.  **第三层（Layer 2）：C1 编译 + Profiling**：在 C1 编译的基础上，增加性能监控（Profiling），收集运行时的性能数据，为后续的 C2 编译提供依据。
4.  **第四层（Layer 3）：C2 编译**：使用 C2 编译器进行深度优化，生成高质量的机器码。

### 4.6 优点

*   **性能提升**：将热点代码编译成机器码，显著提高程序的执行效率。
*   **动态优化**：能够根据程序的运行时特征进行优化，适应性强。

### 4.7 缺点

*   **编译开销**：JIT 编译需要消耗额外的时间和资源。
*   **代码膨胀**：编译后的机器码会占用额外的内存空间。

## 5. 总结

执行引擎是 JVM 的核心组件，负责将字节码转换为机器指令并执行。 解释器和 JIT 编译器各有优缺点，通过分层编译策略，JVM 能够在启动速度和运行性能之间取得平衡。 深入理解执行引擎的工作原理，有助于我们编写更高性能的 Java 程序。
